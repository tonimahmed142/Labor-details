<!doctype html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>লেবার ম্যানেজমেন্ট (Google Sheets)</title>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"/>
<style>
  body{font-family: Arial, "Noto Sans Bengali", sans-serif;background:#f4f4f4;}
  header{background:#0077cc;color:#fff;padding:12px;text-align:center;font-size:20px;}
  .container{max-width:1000px;margin:18px auto;padding:14px;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
  .hidden{display:none}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #ddd;padding:8px;text-align:center}
  th{background:#0077cc;color:#fff}
  .red{background:#ffdddd}
  .tab-btn{margin-right:6px}
  input,select,textarea{padding:6px;border:1px solid #ddd;border-radius:4px}
  .small{font-size:13px;color:#555}
  a.pointer{cursor:pointer;color:#0077cc}
</style>
</head>
<body>
<header>লেবার কাজ এবং বিল - Google Sheets</header>

<div class="container" id="loginPage">
  <h4>লগইন</h4>
  <div>
    <button class="btn btn-primary" onclick="adminLogin()">Admin Login</button>
    <button class="btn btn-outline-primary" onclick="openDashboard('viewer')">View Details</button>
  </div>
  <p class="small mt-2">Admin password: <strong>2005</strong></p>
  <p class="small text-muted">Make sure you paste your Apps Script URL below in the code.</p>
</div>

<div class="container hidden" id="passwordBox">
  <h5>অ্যাডমিন পাসওয়ার্ড দিন</h5>
  <input id="adminPass" type="password" placeholder="Password">
  <button class="btn btn-primary" onclick="checkPassword()">Submit</button>
  <button class="btn btn-secondary" onclick="backToLogin()">Back</button>
</div>

<div class="container hidden" id="dashboard">
  <div class="d-flex align-items-center mb-2">
    <button class="btn btn-sm btn-outline-secondary tab-btn" id="dailyTab" onclick="showTab('daily')">Daily Work</button>
    <button class="btn btn-sm btn-outline-secondary tab-btn" id="permTab" onclick="showTab('perm')">Permanent Workers</button>
    <div style="flex:1"></div>
    <button class="btn btn-sm btn-danger" onclick="logout()">Logout</button>
  </div>

  <!-- Daily section -->
  <div id="dailySection">
    <h5>দৈনিক কাজ</h5>

    <div id="adminControls" class="mb-2 hidden">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <div>
          <input id="nameInput" list="namesList" placeholder="নাম">
          <datalist id="namesList"></datalist>
        </div>
        <input id="dateInput" type="date">
        <input id="detailsInput" placeholder="বিবরণ (e.g. Payment)">
        <input id="bakiInput" type="number" placeholder="বাকী">
        <input id="jamaInput" type="number" placeholder="জমা">
        <input id="totalInput" type="number" placeholder="মোট">
        <select id="sectionInput">
          <option value="daily">Daily</option>
          <option value="permanent">Permanent</option>
        </select>
        <button class="btn btn-primary" onclick="addRecord()">Add</button>
      </div>
      <div class="small mt-1">Tip: include "Payment" in বিবরণ or fill জমা > 0 to mark payment row.</div>
    </div>

    <table id="dailyTable">
      <thead>
        <tr><th>নাম</th><th>তারিখ</th><th>বিবরণ</th><th>বাকী</th><th>জমা</th><th>মোট</th><th class="admin-only hidden">Action</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Permanent -->
  <div id="permSection" class="hidden">
    <h5>স্থায়ী শ্রমিক</h5>
    <table id="workerTable">
      <thead><tr><th>নাম</th><th>মোট বাকী</th><th>মোট জমা</th><th>মোট (ব্যালান্স)</th><th>মোট কাজ</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Worker details -->
<div class="container hidden" id="workerDetails">
  <h5 id="workerTitle">Worker</h5>
  <table>
    <thead><tr><th>তারিখ</th><th>বিবরণ</th><th>বাকী</th><th>জমা</th><th>মোট</th><th>মোট (রানিং)</th></tr></thead>
    <tbody id="workerDetailBody"></tbody>
  </table>
  <div class="mt-2"><button class="btn btn-secondary" onclick="closeWorkerDetails()">Back</button></div>
</div>

<script>
/* =======================
   CONFIG — Replace these
   ======================= */
// Put your deployed Apps Script web app URL here (the one you used and works for POST)
// Example: "https://script.google.com/macros/s/AKfycb.../exec"
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwSvfHhKOMdlzmuEYVc7HPhYcFLG2h6aKNiKOy7YDDhgcDEXVuVWsXGt2XyHE0Vo-BBCQ/exec";

// Optional: If you published sheet as CSV, put the CSV URL here (helps when doGet is not implemented)
const CSV_URL = ""; // e.g. "https://docs.google.com/spreadsheets/d/e/2PACX-.../pub?output=csv"

let mode = ""; // "admin" or "viewer"
let records = []; // in-memory cache of rows: each row expected to have keys: id (if available), name, date, description, baki, joma, total, section

/* ---------- UI control ---------- */
function adminLogin(){ document.getElementById('loginPage').classList.add('hidden'); document.getElementById('passwordBox').classList.remove('hidden'); }
function backToLogin(){ document.getElementById('passwordBox').classList.add('hidden'); document.getElementById('loginPage').classList.remove('hidden'); }
function checkPassword(){ const pass = document.getElementById('adminPass').value.trim(); if(pass === "2005") openDashboard('admin'); else alert('Wrong password!'); }
function openDashboard(t){ mode = t; document.getElementById('loginPage').classList.add('hidden'); document.getElementById('passwordBox').classList.add('hidden'); document.getElementById('dashboard').classList.remove('hidden'); if(mode==='admin'){ document.getElementById('adminControls').classList.remove('hidden'); document.querySelectorAll('.admin-only').forEach(e=>e.classList.remove('hidden')); } loadAll(); }
function logout(){ location.reload(); }
function showTab(tab){ if(tab==='daily'){ document.getElementById('dailySection').classList.remove('hidden'); document.getElementById('permSection').classList.add('hidden'); } else { document.getElementById('dailySection').classList.add('hidden'); document.getElementById('permSection').classList.remove('hidden'); renderWorkerTable(); } }

/* =========================
   DATA: Read (GET) & Write (POST)
   ========================= */

/* Try to GET data from Apps Script first (expects JSON response from doGet?action=getAll),
   otherwise fallback to published CSV (if CSV_URL set).
   NOTE: many Apps Script deployments used for simple forms don't implement doGet JSON.
*/
async function loadAll(){
  try {
    // attempt to call Apps Script GET with action=getAll
    const url = new URL(SCRIPT_URL);
    url.searchParams.set('action','getAll');
    const res = await fetch(url.toString());
    if(res.ok){
      const json = await res.json();
      if(json && json.success && Array.isArray(json.data)){
        records = normalizeRecords(json.data);
        updateNamesList();
        renderDailyTable();
        renderWorkerTable();
        return;
      }
    }
  } catch(e){
    console.warn('Apps Script GET failed:', e);
  }

  // fallback: try CSV if provided
  if(CSV_URL){
    try {
      const r = await fetch(CSV_URL);
      if(r.ok){
        const text = await r.text();
        const parsed = parseCSV(text);
        records = normalizeRecords(parsed);
        updateNamesList();
        renderDailyTable();
        renderWorkerTable();
        return;
      }
    } catch(err){
      console.warn('CSV fetch failed:', err);
    }
  }

  // if both fail, keep records empty and show a warning
  records = [];
  updateNamesList();
  renderDailyTable();
  renderWorkerTable();
  console.warn('No data loaded. Ensure your Apps Script supports GET or provide CSV_URL.');
}

/* Helper to normalize different backends into consistent record objects */
function normalizeRecords(arr){
  // arr may be array of objects or array of arrays (from CSV parsing)
  return arr.map((r, i) => {
    // if it's an object with headers:
    if(typeof r === 'object' && !Array.isArray(r)){
      return {
        id: r.id || r.timestamp || r.rowId || String(i),
        name: (r.name||r.Name||r.নাম||'').toString(),
        date: (r.date||r.Date||r.তারিখ||'').toString(),
        description: (r.description||r.details||r.বিবরণ||'').toString(),
        baki: parseFloat(r.baki||r.Baki||r.বাকী||0) || 0,
        joma: parseFloat(r.joma||r.jama||r.Joma||r.জমা||0) || 0,
        total: parseFloat(r.total||r.Total||0) || 0,
        section: (r.section||'daily').toString(),
        payment_status: (r.payment_status||'').toString()
      };
    } else if(Array.isArray(r)){
      // assume CSV row array: try to map by common positions:
      // fallback mapping: [timestamp,name,date,description,baki,joma,total,section]
      return {
        id: r[0] || String(i),
        name: r[1]||'',
        date: r[2]||'',
        description: r[3]||'',
        baki: parseFloat(r[4]||0)||0,
        joma: parseFloat(r[5]||0)||0,
        total: parseFloat(r[6]||0)||0,
        section: r[7]||'daily',
        payment_status: r[8]||''
      };
    } else {
      return { id:String(i), name:'', date:'', description:'', baki:0, joma:0, total:0, section:'daily', payment_status:'' };
    }
  });
}

/* POST form (add) — uses FormData like your working form */
async function addRecord(){
  const name = document.getElementById('nameInput').value.trim();
  const date = document.getElementById('dateInput').value;
  const description = document.getElementById('detailsInput').value.trim();
  const baki = document.getElementById('bakiInput').value || 0;
  const joma = document.getElementById('jamaInput').value || 0;
  const total = document.getElementById('totalInput').value || 0;
  const section = document.getElementById('sectionInput').value || 'daily';
  if(!name || !date){ alert('নাম এবং তারিখ প্রয়োজন'); return; }

  // Build FormData like your working sample
  const fd = new FormData();
  // The Apps Script you showed maps e.parameter[header] using sheet headers.
  // Make form keys match your sheet headers. If your sheet headers are different, change keys below.
  fd.append('name', name);
  fd.append('date', date);
  fd.append('description', description);
  fd.append('baki', baki);
  fd.append('joma', joma);
  fd.append('total', total);
  fd.append('section', section);
  // optional: add payment_status if joma > 0
  if(parseFloat(joma) > 0) fd.append('payment_status', 'Paid'); else fd.append('payment_status','');

  try {
    const resp = await fetch(SCRIPT_URL, { method: 'POST', body: fd });
    if(resp.ok){
      // clear inputs
      document.getElementById('nameInput').value='';
      document.getElementById('dateInput').value='';
      document.getElementById('detailsInput').value='';
      document.getElementById('bakiInput').value='';
      document.getElementById('jamaInput').value='';
      document.getElementById('totalInput').value='';
      // refresh view
      await loadAll();
      alert('Added successfully');
    } else {
      throw new Error('Post failed: ' + resp.status);
    }
  } catch (err){
    console.error(err);
    alert('Network error while trying to save. Check SCRIPT_URL and that Apps Script is deployed and accessible.');
  }
}

/* EDIT & DELETE: These need server support.
   We attempt to call SCRIPT_URL with form field "action" set to update/delete plus the id.
   If your Apps Script doesn't implement update/delete, these will fail — you'll need to add endpoints.
*/
async function editRecord(id){
  const rec = records.find(r=>String(r.id) === String(id));
  if(!rec) return alert('Record not found');
  const name = prompt('নাম:', rec.name) || rec.name;
  const date = prompt('তারিখ (YYYY-MM-DD):', rec.date) || rec.date;
  const description = prompt('বিবরণ:', rec.description) || rec.description;
  const baki = prompt('বাকী:', rec.baki) || rec.baki;
  const joma = prompt('জমা:', rec.joma) || rec.joma;
  const total = prompt('মোট:', rec.total) || rec.total;

  // Try to send JSON with action=update
  try {
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ action: 'updateRecord', id, record: { name, date, description, baki, joma, total } })
    });
    if(res.ok){
      const json = await res.json().catch(()=>null);
      // if server returns success, refresh
      await loadAll();
      alert('Update attempted. If your Apps Script supports update, it succeeded.');
    } else {
      throw new Error('Server returned ' + res.status);
    }
  } catch(err){
    console.error(err);
    alert('Update failed. Your Apps Script must implement update functionality to support edit. See note below.');
  }
}

async function deleteRecord(id){
  if(!confirm('আপনি কি মুছে ফেলতে চান?')) return;
  try {
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ action: 'deleteRecord', id })
    });
    if(res.ok){
      await loadAll();
      alert('Delete attempted. If supported, record removed.');
    } else {
      throw new Error('Server returned ' + res.status);
    }
  } catch(err){
    console.error(err);
    alert('Delete failed. Your Apps Script must implement delete functionality to support this.');
  }
}

/* =========================
   RENDER TABLES / UI
   ========================= */
function updateNamesList(){
  const set = new Set();
  records.forEach(r=>{ if(r.name) set.add(r.name.trim()); });
  const datalist = document.getElementById('namesList');
  datalist.innerHTML = '';
  Array.from(set).sort((a,b)=> a.localeCompare(b,'bn')).forEach(n=>{
    const opt = document.createElement('option'); opt.value = n; datalist.appendChild(opt);
  });
}

function renderDailyTable(){
  const tbody = document.querySelector('#dailyTable tbody');
  tbody.innerHTML = '';
  const data = records.slice().filter(r=> r.section === 'daily' || !r.section).sort((a,b)=> new Date(a.date) - new Date(b.date));
  data.forEach(r=>{
    const tr = document.createElement('tr');
    if((r.description||'').toLowerCase().includes('payment') || parseFloat(r.joma) > 0) tr.classList.add('red');
    tr.innerHTML = `<td>${escapeHtml(r.name)}</td>
                    <td>${escapeHtml(r.date)}</td>
                    <td>${escapeHtml(r.description)}</td>
                    <td>${(parseFloat(r.baki)||0).toFixed(2)}</td>
                    <td>${(parseFloat(r.joma)||0).toFixed(2)}</td>
                    <td>${(parseFloat(r.total)||0).toFixed(2)}</td>
                    ${mode==='admin' ? `<td class="admin-only"><button onclick="editRecord('${escapeJS(r.id)}')">Edit</button> <button onclick="deleteRecord('${escapeJS(r.id)}')">Delete</button></td>` : ''}`;
    tbody.appendChild(tr);
  });
}

function renderWorkerTable(){
  const tbody = document.querySelector('#workerTable tbody');
  tbody.innerHTML = '';
  const map = {};
  // include records and names with section permanent
  records.forEach(r=>{
    const name = r.name || 'Unknown';
    if(!map[name]) map[name] = { baki:0, joma:0, count:0 };
    map[name].baki += parseFloat(r.baki||0);
    map[name].joma += parseFloat(r.joma||0);
    map[name].count += 1;
  });
  Object.keys(map).sort((a,b)=>a.localeCompare(b,'bn')).forEach(name=>{
    const item = map[name];
    const balance = item.baki - item.joma;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><a class="pointer" onclick="showWorkerDetails('${escapeJS(name)}')">${escapeHtml(name)}</a></td>
                    <td>${item.baki.toFixed(2)}</td>
                    <td>${item.joma.toFixed(2)}</td>
                    <td>${balance.toFixed(2)}</td>
                    <td>${item.count}</td>`;
    tbody.appendChild(tr);
  });
}

function showWorkerDetails(name){
  document.getElementById('dashboard').classList.add('hidden');
  document.getElementById('workerDetails').classList.remove('hidden');
  document.getElementById('workerTitle').innerText = name + ' - বিস্তারিত';
  const data = records.filter(r=> (r.name||'') === name).slice().sort((a,b)=> new Date(a.date) - new Date(b.date));
  const tbody = document.getElementById('workerDetailBody'); tbody.innerHTML = '';
  let running = 0;
  data.forEach(r=>{
    running += (parseFloat(r.baki||0) - parseFloat(r.joma||0));
    const tr = document.createElement('tr');
    if((r.description||'').toLowerCase().includes('payment') || parseFloat(r.joma) > 0) tr.classList.add('red');
    tr.innerHTML = `<td>${escapeHtml(r.date)}</td>
                    <td>${escapeHtml(r.description)}</td>
                    <td>${(parseFloat(r.baki)||0).toFixed(2)}</td>
                    <td>${(parseFloat(r.joma)||0).toFixed(2)}</td>
                    <td>${(parseFloat(r.total)||0).toFixed(2)}</td>
                    <td>${running.toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });
}

function closeWorkerDetails(){ document.getElementById('workerDetails').classList.add('hidden'); document.getElementById('dashboard').classList.remove('hidden'); }

/* =========================
   Utilities: CSV parse, escape
   ========================= */
function parseCSV(text){
  // very simple CSV parser (no quoted-field edge cases)
  const lines = text.trim().split(/\r?\n/).map(l=>l.split(','));
  // If first row is header, convert to objects
  if(lines.length < 1) return [];
  const headers = lines[0].map(h=>h.trim());
  const rows = lines.slice(1).map(r=>{
    const obj = {};
    headers.forEach((h,i)=> obj[h] = r[i] || '');
    return obj;
  });
  return rows;
}

function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escapeJS(s){ if(s==null) return ''; return String(s).replace(/'/g,"\\'").replace(/"/g,'\\"'); }

/* =========================
   On load: nothing — wait for login
   ========================= */

</script>
</body>
</html>
