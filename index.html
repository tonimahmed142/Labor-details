<!doctype html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>লেবার ম্যানেজমেন্ট (Offline)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body{font-family: "Noto Sans Bengali", Arial, sans-serif; background:#f4f4f4; color:#222}
  header{background:#0077cc;color:#fff;padding:14px;text-align:center;font-weight:600}
  .app{max-width:1100px;margin:18px auto;padding:16px;background:#fff;border-radius:8px;box-shadow:0 4px 18px rgba(0,0,0,0.08)}
  .hidden{display:none}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border:1px solid #e1e1e1;text-align:center}
  th{background:#0077cc;color:#fff}
  .red{background:#ffdddd}
  .tab-btn{margin-right:6px}
  input,select,textarea{padding:6px;border:1px solid #ddd;border-radius:5px}
  .small{font-size:13px;color:#555}
  a.pointer{cursor:pointer;color:#0077cc}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .controls > *{min-width:120px}
  .btn-small{padding:.375rem .5rem;font-size:.85rem}
  @media(max-width:820px){
    .controls{flex-direction:column;align-items:stretch}
    .controls > *{width:100%}
  }
</style>
</head>
<body>
<header>লেবার কাজ ও বিল — Offline (localStorage)</header>

<div class="app" id="loginPage">
  <h4>লগইন</h4>
  <div class="mb-2">
    <button class="btn btn-primary" onclick="adminLogin()">Admin Login</button>
    <button class="btn btn-outline-primary" onclick="openDashboard('viewer')">View Details</button>
    <button class="btn btn-sm btn-secondary float-right" onclick="exportCSV()">Export CSV</button>
    <label class="btn btn-sm btn-info mb-0 float-right mr-2">
      Import CSV <input type="file" id="csvFile" accept=".csv" style="display:none" onchange="importCSV(event)">
    </label>
  </div>
  <p class="small">Admin password: <strong>2005</strong></p>
  <p class="small">Data saved locally on this browser. Use Export CSV to backup.</p>
</div>

<div class="app hidden" id="passwordBox">
  <h5>অ্যাডমিন পাসওয়ার্ড দিন</h5>
  <div class="d-flex" style="gap:8px">
    <input id="adminPass" type="password" class="form-control" placeholder="Password">
    <button class="btn btn-primary" onclick="checkPassword()">Submit</button>
    <button class="btn btn-secondary" onclick="backToLogin()">Back</button>
  </div>
</div>

<div class="app hidden" id="dashboard">
  <div class="d-flex align-items-center mb-2">
    <button class="btn btn-sm btn-outline-secondary tab-btn" id="dailyTabBtn" onclick="showTab('daily')">Daily Work</button>
    <button class="btn btn-sm btn-outline-secondary tab-btn" id="permTabBtn" onclick="showTab('perm')">Permanent Workers</button>
    <div style="flex:1"></div>
    <button class="btn btn-sm btn-warning btn-small mr-2" onclick="exportCSV()">Export CSV</button>
    <button class="btn btn-sm btn-danger btn-small" onclick="clearAllConfirm()">Clear All</button>
    <button class="btn btn-sm btn-secondary btn-small ml-2" onclick="logout()">Logout</button>
  </div>

  <!-- DAILY -->
  <div id="dailySection">
    <h5>দৈনিক কাজ</h5>
    <div id="adminControls" class="mb-2 hidden">
      <div class="controls">
        <div>
          <input id="nameInput" list="namesList" class="form-control" placeholder="নাম">
          <datalist id="namesList"></datalist>
        </div>
        <input id="dateInput" type="date" class="form-control" />
        <input id="detailsInput" class="form-control" placeholder="বিবরণ (উদাহরণ: Payment, Brick work)" />
        <input id="bakiInput" type="number" class="form-control" placeholder="বাকী" />
        <input id="jamaInput" type="number" class="form-control" placeholder="জমা" />
        <input id="totalInput" type="number" class="form-control" placeholder="মোট" />
        <select id="sectionInput" class="form-control">
          <option value="daily">Daily</option>
          <option value="permanent">Permanent</option>
        </select>
        <button class="btn btn-primary" onclick="addRecord()">Add</button>
      </div>
      <div class="small mt-1">Tip: লেখনায় "Payment" লিখলে অথবা জমা (জমা) > 0 হলে ওই সারি লাল দেখাবে।</div>
    </div>

    <table id="dailyTable">
      <thead>
        <tr>
          <th>নাম</th><th>তারিখ</th><th>বিবরণ</th><th>বাকী</th><th>জমা</th><th>মোট</th><th class="admin-only hidden">Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- PERMANENT -->
  <div id="permSection" class="hidden mt-3">
    <h5>স্থায়ী শ্রমিক</h5>
    <div class="small mb-2">Click a name to see detailed history (row-by-row) with running total.</div>
    <table id="workerTable">
      <thead>
        <tr><th>নাম</th><th>মোট বাকী</th><th>মোট জমা</th><th>মোট (ব্যালান্স)</th><th>মোট কাজ</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Worker details -->
<div class="app hidden" id="workerDetails">
  <h5 id="workerTitle">Worker</h5>
  <table>
    <thead><tr><th>তারিখ</th><th>বিবরণ</th><th>বাকী</th><th>জমা</th><th>মোট</th><th>মোট (রানিং)</th></tr></thead>
    <tbody id="workerDetailBody"></tbody>
  </table>
  <div class="mt-2"><button class="btn btn-secondary" onclick="closeWorkerDetails()">Back</button></div>
</div>

<script>
/* ===========================
   Offline app using localStorage
   =========================== */

const STORAGE_KEY = 'laborRecords_v1'; // if you want to reset structure later, change version

let mode = ''; // 'admin' or 'viewer'
let records = []; // array of {id, name, date, description, baki, jama, total, section}
document.addEventListener('DOMContentLoaded', ()=> {
  // nothing until login
});

/* -------------------------
   Auth / Navigation
   ------------------------- */
function adminLogin(){ document.getElementById('loginPage').classList.add('hidden'); document.getElementById('passwordBox').classList.remove('hidden'); }
function backToLogin(){ document.getElementById('passwordBox').classList.add('hidden'); document.getElementById('loginPage').classList.remove('hidden'); }
function checkPassword(){ const p = document.getElementById('adminPass').value; if(p === '2005') openDashboard('admin'); else alert('Wrong password!'); }
function openDashboard(t){
  mode = t;
  document.getElementById('loginPage').classList.add('hidden');
  document.getElementById('passwordBox').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  if(mode === 'admin'){ document.getElementById('adminControls').classList.remove('hidden'); document.querySelectorAll('.admin-only').forEach(e=>e.classList.remove('hidden')); }
  loadFromStorage();
  showTab('daily');
}
function logout(){ location.reload(); }
function showTab(tab){
  if(tab === 'daily'){
    document.getElementById('dailySection').classList.remove('hidden');
    document.getElementById('permSection').classList.add('hidden');
    document.getElementById('dailyTabBtn').classList.add('btn-primary');
    document.getElementById('permTabBtn').classList.remove('btn-primary');
  } else {
    document.getElementById('dailySection').classList.add('hidden');
    document.getElementById('permSection').classList.remove('hidden');
    document.getElementById('dailyTabBtn').classList.remove('btn-primary');
    document.getElementById('permTabBtn').classList.add('btn-primary');
    renderWorkerTable();
  }
}

/* -------------------------
   Storage
   ------------------------- */
function loadFromStorage(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    records = raw ? JSON.parse(raw) : [];
  } catch(e){
    console.error('loadFromStorage error', e);
    records = [];
  }
  updateNamesDatalist();
  renderDailyTable();
  renderWorkerTable();
}

function saveToStorage(){
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
  } catch(e){
    console.error('saveToStorage error', e);
  }
}

/* -------------------------
   Add / Edit / Delete
   ------------------------- */
function addRecord(){
  const name = document.getElementById('nameInput').value.trim();
  const date = document.getElementById('dateInput').value;
  const description = document.getElementById('detailsInput').value.trim();
  const baki = parseFloat(document.getElementById('bakiInput').value) || 0;
  const jama = parseFloat(document.getElementById('jamaInput').value) || 0;
  const total = parseFloat(document.getElementById('totalInput').value) || 0;
  const section = document.getElementById('sectionInput').value || 'daily';
  if(!name || !date){ alert('নাম এবং তারিখ দিন'); return; }
  const id = Date.now().toString(36) + Math.floor(Math.random()*1000);
  records.push({ id, name, date, description, baki, jama, total, section });
  saveToStorage();
  clearAddInputs();
  updateNamesDatalist();
  renderDailyTable();
  renderWorkerTable();
}

function clearAddInputs(){
  document.getElementById('nameInput').value='';
  document.getElementById('dateInput').value='';
  document.getElementById('detailsInput').value='';
  document.getElementById('bakiInput').value='';
  document.getElementById('jamaInput').value='';
  document.getElementById('totalInput').value='';
  document.getElementById('sectionInput').value='daily';
}

function editRecord(id){
  const rec = records.find(r=> r.id === id);
  if(!rec) return alert('Record not found');
  const name = prompt('নাম:', rec.name) || rec.name;
  const date = prompt('তারিখ (YYYY-MM-DD):', rec.date) || rec.date;
  const description = prompt('বিবরণ:', rec.description) || rec.description;
  const baki = parseFloat(prompt('বাকী:', rec.baki) || rec.baki) || 0;
  const jama = parseFloat(prompt('জমা:', rec.jama) || rec.jama) || 0;
  const total = parseFloat(prompt('মোট:', rec.total) || rec.total) || 0;
  rec.name = name; rec.date = date; rec.description = description; rec.baki = baki; rec.jama = jama; rec.total = total;
  saveToStorage();
  updateNamesDatalist();
  renderDailyTable();
  renderWorkerTable();
}

function deleteRecord(id){
  if(!confirm('আপনি কি রেকর্ডটি মুছে ফেলতে চান?')) return;
  records = records.filter(r=> r.id !== id);
  saveToStorage();
  updateNamesDatalist();
  renderDailyTable();
  renderWorkerTable();
}

/* -------------------------
   Rendering tables
   ------------------------- */
function renderDailyTable(){
  const tbody = document.querySelector('#dailyTable tbody');
  tbody.innerHTML = '';
  const data = records.slice().filter(r => r.section === 'daily' || !r.section).sort((a,b) => new Date(a.date) - new Date(b.date));
  data.forEach(r=>{
    const tr = document.createElement('tr');
    if((r.description||'').toLowerCase().includes('payment') || (parseFloat(r.jama)||0) > 0) tr.classList.add('red');
    const actions = mode === 'admin' ? `<td><button class="btn btn-sm btn-info btn-small mr-1" onclick="editRecord('${r.id}')">Edit</button><button class="btn btn-sm btn-danger btn-small" onclick="deleteRecord('${r.id}')">Delete</button></td>` : '';
    tr.innerHTML = `<td>${escapeHtml(r.name)}</td>
                    <td>${escapeHtml(r.date)}</td>
                    <td>${escapeHtml(r.description)}</td>
                    <td>${(parseFloat(r.baki)||0).toFixed(2)}</td>
                    <td>${(parseFloat(r.jama)||0).toFixed(2)}</td>
                    <td>${(parseFloat(r.total)||0).toFixed(2)}</td>
                    ${actions}`;
    tbody.appendChild(tr);
  });
}

function renderWorkerTable(){
  const tbody = document.querySelector('#workerTable tbody');
  tbody.innerHTML = '';
  const map = {}; // name -> {baki,jama,count}
  records.forEach(r=>{
    const n = r.name || 'Unknown';
    if(!map[n]) map[n] = { baki:0, jama:0, count:0 };
    map[n].baki += parseFloat(r.baki || 0);
    map[n].jama += parseFloat(r.jama || 0);
    map[n].count += 1;
  });
  // include names from records only (you can add manual permanent names by adding records with section 'permanent')
  Object.keys(map).sort((a,b)=> a.localeCompare(b,'bn')).forEach(name=>{
    const it = map[name];
    const balance = it.baki - it.jama;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><a class="pointer" onclick="showWorkerDetails('${escapeJS(name)}')">${escapeHtml(name)}</a></td>
                    <td>${it.baki.toFixed(2)}</td>
                    <td>${it.jama.toFixed(2)}</td>
                    <td>${balance.toFixed(2)}</td>
                    <td>${it.count}</td>`;
    tbody.appendChild(tr);
  });
}

/* -------------------------
   Worker details (row-by-row) with running total
   ------------------------- */
function showWorkerDetails(name){
  document.getElementById('dashboard').classList.add('hidden');
  document.getElementById('workerDetails').classList.remove('hidden');
  document.getElementById('workerTitle').innerText = name + ' - কার্যকারিতা';
  const data = records.filter(r => (r.name||'') === name).slice().sort((a,b) => new Date(a.date) - new Date(b.date));
  const tbody = document.getElementById('workerDetailBody');
  tbody.innerHTML = '';
  let running = 0;
  data.forEach(r=>{
    running += (parseFloat(r.baki || 0) - parseFloat(r.jama || 0));
    const tr = document.createElement('tr');
    if((r.description||'').toLowerCase().includes('payment') || (parseFloat(r.jama)||0) > 0) tr.classList.add('red');
    tr.innerHTML = `<td>${escapeHtml(r.date)}</td>
                    <td>${escapeHtml(r.description)}</td>
                    <td>${(parseFloat(r.baki)||0).toFixed(2)}</td>
                    <td>${(parseFloat(r.jama)||0).toFixed(2)}</td>
                    <td>${(parseFloat(r.total)||0).toFixed(2)}</td>
                    <td>${running.toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });
}

function closeWorkerDetails(){
  document.getElementById('workerDetails').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
}

/* -------------------------
   Name suggestions (datalist)
   ------------------------- */
function updateNamesDatalist(){
  const set = new Set();
  records.forEach(r => { if(r.name) set.add(r.name.trim()); });
  const datalist = document.getElementById('namesList');
  datalist.innerHTML = '';
  Array.from(set).sort((a,b)=> a.localeCompare(b,'bn')).forEach(n=>{
    const opt = document.createElement('option'); opt.value = n; datalist.appendChild(opt);
  });
}

/* -------------------------
   CSV Export / Import
   ------------------------- */
function exportCSV(){
  if(!records || records.length === 0){ alert('No records to export'); return; }
  const headers = ['id','name','date','description','baki','jama','total','section'];
  const rows = records.map(r => headers.map(h => JSON.stringify(r[h] != null ? r[h] : '')));
  const csv = [headers.join(',')].concat(rows.map(r => r.join(','))).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'labor_data.csv'; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

function importCSV(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(evt){
    try {
      const text = evt.target.result;
      const parsed = parseCSV(text); // returns array of objects
      // normalize to our schema
      const newRecords = parsed.map((row, i) => {
        return {
          id: row.id || ('imp' + Date.now().toString(36) + i),
          name: row.name || row.Name || '',
          date: row.date || row.Date || '',
          description: row.description || row.Description || row.details || '',
          baki: parseFloat(row.baki || row.Baki || 0) || 0,
          jama: parseFloat(row.jama || row.Joma || 0) || 0,
          total: parseFloat(row.total || 0) || 0,
          section: row.section || 'daily'
        };
      });
      records = newRecords;
      saveToStorage();
      updateNamesDatalist();
      renderDailyTable();
      renderWorkerTable();
      alert('Imported CSV successfully');
      document.getElementById('csvFile').value = '';
    } catch(err){
      console.error(err);
      alert('Failed to import CSV');
    }
  };
  reader.readAsText(file);
}

/* -------------------------
   Utilities / helpers
   ------------------------- */
function parseCSV(text){
  // handle quoted cells by simple regex replace; works for typical CSV exports
  const rows = [];
  const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
  if(lines.length === 0) return [];
  const headers = splitCSVLine(lines[0]);
  for(let i=1;i<lines.length;i++){
    const cols = splitCSVLine(lines[i]);
    const obj = {};
    headers.forEach((h,idx) => obj[h.trim()] = cols[idx] ? cols[idx].replace(/^"|"$/g,'') : '');
    rows.push(obj);
  }
  return rows;
}

function splitCSVLine(line){
  // split respecting quoted commas
  const result = [];
  let cur = '', inQuotes = false;
  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"' ) { inQuotes = !inQuotes; cur += ch; continue; }
    if(ch === ',' && !inQuotes){ result.push(cur); cur = ''; continue; }
    cur += ch;
  }
  result.push(cur);
  return result;
}

function escapeHtml(s){ if(s===null || s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escapeJS(s){ if(s===null || s===undefined) return ''; return String(s).replace(/'/g,"\\'").replace(/"/g,'\\"'); }

/* -------------------------
   Clear all data
   ------------------------- */
function clearAllConfirm(){
  if(!confirm('Are you sure? This will erase all stored records locally.')) return;
  localStorage.removeItem(STORAGE_KEY);
  records = [];
  updateNamesDatalist();
  renderDailyTable();
  renderWorkerTable();
  alert('All local data cleared.');
}
</script>
</body>
</html>
